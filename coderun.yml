steps:
  build:
    image: crun/docker
    settings:
      repo_name: hairtail
      registry_name: coderun
      dockerfile: Dockerfile
      tags: ${CI_COMMIT_BRANCH}

  deploy:
    image: crun/kube
    settings:
      cluster_name: myk8s
      template: deployment.yml
      namespace: default
    environment:
      - REPLICAS=1
      - INGRESS=hairtail.d.k.hscloud.top
      - HTAIL_DB_URL="host=cpp-db port=5432 user=postgres dbname=hairtail sslmode=disable password=huansi@2017"
      - HTAIL_TARGET_DB_URL="host=cpp-db port=5432 user=postgres dbname=hairtail sslmode=disable password=huansi@2017"
    when:
      branch: dev
